
<!DOCTYPE HTML>
<!--suppress ALL -->
<html>
<head>
  <title>Timeline | Nested Groups example</title>

  <style>
    body, html {
      font-family: arial, sans-serif;
      font-size: 11pt;
    }

    #visualization {
      box-sizing: border-box;
      width: 100%;
      height: auto;
    }
  </style>

  <!-- note: moment.js must be loaded before vis.js, else vis.js uses its embedded version of moment.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.8.4/moment.min.js"></script>

  <script src="node_modules/vis/dist/vis.min.js"></script>
  <link href="node_modules/vis/dist/vis.min.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="visualization"></div>
<div id="log"></div>

<script>
  function GetServerId(serverType, deployType){
      return `${serverType}/${deployType}`
  }

  Draw()
  async function Draw(){
    const resourceTypes = await (await fetch('/api/resourcetype')).json()
    const deployTypes = resourceTypes.deployType
    const serverTypes = resourceTypes.serverType

    const serverInfos = await (await fetch('/api/serverinfo')).json()
    const now = moment().minutes(0).seconds(0).milliseconds(0)
    const itemCount = 60

    const groups = new vis.DataSet()

    // Create main groups (deploy types)
    groups.add(deployTypes.map((dt) => ({
        id: `deploy_${dt.id}`,
        content: dt.name,
        nestedGroups: serverTypes.map((st) => GetServerId(st.id, dt.id))
    })))

    // Create sub groups (server types)
    groups.add(serverTypes.reduce((all, st) => {
        deployTypes.forEach((dt) => {
            all.push({
                id: GetServerId(st.id, dt.id),
                content: st.name
            })
        })
        return all
    }, []))

    // create a dataset with items
    var items = new vis.DataSet()
    items.add({
        id: `1/2_1234`,
        group: "1/2",
        content: 'fix/Bugfix/VeryImportantBugfix',
        start: +new Date(),
        end: +new Date() + 3000000,
        type: 'range'
    });

    // create visualization
    var container = document.getElementById('visualization')
    var options = {
      groupOrder: 'content'  // groupOrder can be a property name or a sorting function
    }

    var timeline = new vis.Timeline(container, items, groups, options)
    timeline.on('click', (properties) => {
        OnCreateReservationAsync(properties)
    })

    function StringifyObject(object){
      if (!object) 
        return
      var replacer = function(key, value) {
        if (value && value.tagName) {
          return "DOM Element"
        } else {
          return value
        }
      }
      return JSON.stringify(object, replacer)
    }

    async function OnCreateReservationAsync(properties) {
        const rawResponse = await fetch('api/reservation', {
            method: 'POST',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                DeployType: 1,
                ServerType: 1,
                BranchName: 'fix/Test/Example',
                Author: 'Bálint Juhász',
                ReservedInterval: {
                    From: new Date().toJSON(),
                    To: new Date(+new Date() + 3000000).toJSON()
                },
            })
        });
        const content = await rawResponse.json();
        console.log(content);
    }
    
    function logEvent(event, properties){
        console.log(event, properties);
      /*var log = document.getElementById('log')
      var msg = document.createElement('div')
      msg.innerHTML = 'event=' + JSON.stringify(event) + ', ' +
          'properties=' + StringifyObject(properties)
      log.firstChild ? log.insertBefore(msg, log.firstChild) : log.appendChild(msg)*/
    }
  }
</script>
</body>
</html>